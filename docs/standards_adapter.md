# 会计准则自适应模块（Standards Adapter）

> 一句话：让 2015 年和 2022 年的报表，也能放在一张图里比较，而不被“写法变化”骗到。

---

## 1. 背景：为什么偏偏是 2017–2021？

这一模块的设计背景，主要来自 2017–2021 年间财政部对企业会计准则的一轮集中修订，以及实务圈对“新旧报表不可比”的讨论。

非常粗略地讲，这几年发生了三件大事：

- **新金融工具准则落地**  
  2017 年修订发布了第 22 号《金融工具确认和计量》、第 23 号《金融资产转移》、第 24 号《套期会计》、第 37 号《金融工具列报》等，合称“新金融工具准则”。  
  执行节奏大致是：
  - 境内外同时上市及境外上市企业自 2018 年 1 月 1 日起施行；
  - 其他境内上市企业自 2019 年 1 月 1 日起施行；
  - 非上市但执行企业会计准则的企业，自 2021 年 1 月 1 日起施行。

- **新收入准则落地**  
  2017 年修订发布第 14 号《收入》，统一了收入和建造合同的确认模型，引入控制权转移的“五步法”。  
  执行节奏类似：
  - 境内外同时上市及境外上市企业自 2018 年 1 月 1 日起施行；
  - 其他境内上市企业自 2020 年 1 月 1 日起施行。

- **新租赁准则落地**  
  2018 年修订发布第 21 号《租赁》，要求除短期/低价值租赁外，承租人不再区分经营租赁和融资租赁，大部分租赁要确认为“使用权资产 + 租赁负债”。  
  - 境内外同时上市及境外上市企业自 2019 年 1 月 1 日起施行；
  - 其他境内上市企业自 2021 年 1 月 1 日起施行。

这几套新准则叠加在一起，直接改变了：

- 金融资产和负债的分类方式（比如“可供出售金融资产”消失了）；
- 收入确认的时点和科目（合同资产 / 合同负债的出现）；
- 租赁相关资产负债的表内/表外处理（经营租赁入表）。

对数据工程来说，这意味着：  
**同一家企业的 2016 报表和 2022 报表，不能再只看“科目名称”和“年份”，就假设它们是同一口径。**

本模块的三件事（识别环境、建立映射、返回带注释的指标），就是对这轮新准则变更的一个工程化回应。

---

## 2. 它具体解决了哪些典型坑？

下面用四个最常见的“坑”来说明这个模块的价值。

### 2.1 预收类负债：订单看起来“突然消失”

- 表面现象：某年以后，“预收款项”几乎消失，看起来订单大幅减少。
- 实际情况：
  - 新收入准则下，预收款改到“合同负债”，科目名字变了；
  - 同时把增值税剔掉了，新科目的数值天然比旧科目更小。
- 后果：如果只看“预收款项”这一行，很容易误判“业务变差”。
- 模块做的事：
  - 用 `contract_liabilities_like` 这个业务指标，把：
    - 旧报表的“预收款项 / 预收账款”  
    - 新报表的“合同负债”  
    一起加总成“预收类负债”，再做横向比较；
  - 在返回结果里给出一句简单提示：新旧准则含税口径不同，数值下降不一定是订单变少。

### 2.2 研发费用：旧报表里“凭空消失”

- 表面现象：2018 年之前，很多公司利润表里根本找不到“研发费用”这一行。
- 实际情况：研发支出被记在“管理费用”里，没有单独列示。
- 后果：如果直接读“研发费用 = 0”，模型很容易得出“这家公司不搞研发”的结论。
- 模块做的事：
  - 映射表中，旧准则不强行把“管理费用”当成“研发费用”去算，避免严重高估；
  - 当在旧准则报表中提取 `rd_expenses` 指标时：
    - 数值一般为 0；
    - 同时在结果里自动附带一条说明：旧准则研发费用通常包含在管理费用中，未单独列示。

### 2.3 广义应收票据：被拆散的“票据资产”

- 表面现象：新准则以后，“应收票据”的余额可能突然变小。
- 实际情况：用于背书、贴现的票据，被单独放到“应收款项融资”科目中。
- 后果：如果只看“应收票据”，会低估企业手里可以用来贴现、背书的票据资产。
- 模块做的事：
  - 定义 `notes_receivable_broad`：
    - 新准则：`应收票据 + 应收款项融资`
    - 旧准则：`应收票据`
  - 统一返回“广义应收票据”的值，并说明“已包含应收款项融资”。

### 2.4 租赁负债与拆出资金：隐形债务与隐形现金

- 租赁负债：
  - 旧准则：经营租赁基本不进资产负债表，负债被“藏”在租金里；
  - 新准则：绝大部分租赁都要确认为“使用权资产 + 租赁负债”。
  - 模块通过 `lease_liabilities_total`，把旧报表里的相关长期应付款和新报表里的租赁负债对齐，给出更真实的杠杆水平。

- 拆出资金：
  - 有些集团（例如有财务公司/资金池的企业）会把一部分货币资金以“拆出资金”形式存放或拆借给外部；
  - 新旧报表中，“拆出资金”是否计入货币资金的口径不同；
  - 模块通过 `monetary_funds_broad` 指标，把“货币资金 + 拆出资金”合并成一个“广义货币资金”，避免低估资金池。

---

## 3. 模块由哪几部分组成？

整个功能由三块组成，对应三个问题：

1. **这份报表到底在用老规则还是新规则？**  
   → `StandardsDetector`（准则识别器）
2. **不管叫“预收款项”还是“合同负债”，我只想问：预收类负债有多少？**  
   → `standards_mapping.py`（业务指标 ↔ 科目映射表）
3. **我希望直接拿到一个“已经考虑好口径差异”的指标结果，还有必要的说明。**  
   → `MetricsAccessor`（统一指标访问层）

### 3.1 准则识别器：先搞清楚“环境”

`StandardsDetector` 会做这些事：

- 在财报前几页（重要提示、会计政策变更等）里，查有没有明确写“本公司自某年起执行某某新准则”；
- 在表格里查是否出现诸如“合同负债、使用权资产、租赁负债、应收款项融资、其他权益工具投资”等典型新准则科目；
- 如果前两步都没有定论，再结合年份做兜底判断：
  - 2017–2021 年作为“新旧交替窗”，优先相信披露和科目特征；
  - 在窗口之外（例如 2015、2023），可以直接按配置好的默认 old/new 处理。

输出是一份 `StandardsProfile`，大致长这样：

```json
{
  "revenue": "new",
  "financial_instruments": "old",
  "lease": "new",
  "decided_by": "explicit_note_with_year_fallback"
}
```

### 3.2 映射表：把“会计科目”翻译成“业务指标”

`standards_mapping.py` 里维护的是一张“时空翻译字典”，大致结构是：

```python
STANDARD_SUBJECT_MAPPING = {
    "contract_liabilities_like": {
        "new": ["合同负债"],
        "old": ["预收款项", "预收账款"],
    },
    "notes_receivable_broad": {
        "new": ["应收票据", "应收款项融资"],
        "old": ["应收票据"],
    },
    ...
}
```

你可以只记住业务指标的名字，比如：

- `contract_liabilities_like`：预收类负债
- `notes_receivable_broad`：广义应收票据
- `lease_liabilities_total`：租赁负债总额
- `monetary_funds_broad`：广义货币资金
- `financial_investments_total`：全口径金融投资敞口

具体这些指标在新旧准则下由哪些科目组成，就交给映射表来处理。

### 3.3 统一指标访问层：帮你“想明白再给数”

`MetricsAccessor` 是面向上层使用的接口。

- 输入：
  - 一份报表的完整解析结果（ZenParse 输出的 JSON）；
  - 刚才提到的 `StandardsProfile`。
- 输出：某个业务指标的结果，例如：

```json
{
  "metric": "contract_liabilities_like",
  "value": 50000000.0,
  "subjects_used": ["合同负债"],
  "standard_used": "new",
  "profile_flag": "new",
  "note": "新准则口径：合同负债不含增值税。"
}
```

或者：

```json
{
  "metric": "rd_expenses",
  "value": 0.0,
  "subjects_used": [],
  "standard_used": "old",
  "profile_flag": "old",
  "note": "旧准则：研发费用通常包含在管理费用中，未单独列示，数值可能为0或偏低。"
}
```

也就是说，它不是“生搬硬套科目名”，而是先基于 `StandardsProfile` 选择新/旧科目组合，再把一些关键口径差异用一两句话说明。

---

## 4. 为什么对 AI（大模型）特别重要？

对人类分析师来说，看几页附注，大概就知道：

- “这里口径变了，要自己脑补一下差异”；
- “这里的项目其实拆成了两个科目”。

但对大模型来说，如果你只给它一堆原始数字：

- 它不知道“预收款项”和“合同负债”的关系；
- 它看到“研发费用 = 0”，就很自然地得出“公司不搞研发”的结论。

通过这套模块，我们在数据层就已经：

- 尽量把“本质相同的东西”加总在一起（比如广义应收票据、广义货币资金）；
- 把“确实不容易直接可比”的地方用 `note` 标出来（比如增值税差异、研发费用口径）。

这让后续不管是你自己的分析逻辑，还是一个对话式大模型，都更容易做出接近专业分析师的判断，而不是被报表的“表面变化”所误导。

---

## 5. 在项目中如何使用？

这一功能是完全可选、低侵入的：

1. 使用原来的 `ZenPipeline` 解析 PDF，拿到 `parents / children / table_groups`；
2. 通过 `ZenPipeline.last_standards_profile` 拿到当前报表的 `StandardsProfile`；
3. 在你的业务层构造：

   ```python
   from zenparse.data.metrics_accessor import MetricsAccessor

   accessor = MetricsAccessor(report_data, standards_profile)
   result = accessor.get_metric("contract_liabilities_like")
   ```

4. 在上层（服务接口或 LLM 提示词里）使用 `result["value"]` 和 `result["note"]`，做更稳健的解释和对比。

如果你只关心“切块 + 表格结构”，不做跨年份财报分析，可以完全忽略这个模块；  
如果你希望做 5–10 年的趋势分析，或者要给大模型喂“已经考虑过会计准则差异”的指标，这三块组件就可以派上用场。

---

### 参考资料（推荐阅读）

如果你对背后的会计与投资逻辑感兴趣，可以参考：

- 唐朝，《手把手教你读财报：2021 新准则升级版》，机械工业出版社  
  - 书中对新金融工具、新收入、新租赁准则对财报的影响有通俗而深入的解读，本模块的很多业务指标命名和口径思路都受其启发。
- 财政部会计司发布的相关文件与实施问答  
  - 如各准则修订公告以及针对金融工具、收入、租赁的实施问答，对执行时间、适用范围和具体会计处理有权威说明。

### 说明与致谢

本项目的开发者并非会计专业出身，所有财务相关理解主要来自个人投资过程中的阅读和自学（包括但不限于上述书籍和公开资料）。  
代码和文档难免存在理解偏差或不严谨之处，如你在使用中发现任何错误或有更好的口径建议，非常欢迎指正：

- 邮件：`souflex@163.com`
- 或在仓库中提交 issue

你的反馈会直接帮助这套工具变得更可靠，在此提前致谢。
