# -*- coding: utf-8 -*-

"""
新旧会计准则科目映射配置 (Standards Mapping Configuration)

该模块定义了"业务指标"到"具体会计科目"的映射规则，用于屏蔽新旧准则差异。
设计原则基于《手把手教你读财报（2021新准则升级版）》中的核心逻辑。

使用说明:
1. 结构: { "metric_key": { "new": [科目列表], "old": [科目列表] } }
2. 逻辑: 列表中的科目数值代表"求和"关系。
3. 策略: MetricsAccessor 应优先尝试匹配当前准则列表，未取到值时可回退到另一准则列表。
"""

# =============================================================================
# 第一层：核心业务指标 (Core Business Metrics)
# 适用于绝大多数非金融类上市公司，覆盖经营、债务、资产质量三大维度
# =============================================================================

CORE_MAPPINGS = {
    # -------------------------------------------------------------------------
    # 1. 收入与经营循环 (Revenue & Operating Cycle)
    # -------------------------------------------------------------------------

    # 【预收类负债】核心指标：反映对下游客户的议价能力（"先收钱后发货"）
    # 差异提示：新准则"合同负债"不含增值税，旧准则"预收款项"含增值税。
    # 影响：新旧切换年份数值通常会自然下降约 9%-13%，非业务恶化。
    "contract_liabilities_like": {
        "new": ["合同负债"],
        "old": ["预收款项", "预收账款"],
    },

    # 【已履约未结算权利】核心指标：反映已干活但未获无条件收款权的金额
    # 修正：严格剔除"在建工程"（属于生产性CAPEX，非销售循环）。
    "contract_assets_like": {
        "new": ["合同资产"],
        "old": ["应收账款", "建造合同", "存货"],
    },

    # -------------------------------------------------------------------------
    # 2. 债务与融资 (Debt & Financing)
    # -------------------------------------------------------------------------

    # 【租赁负债总额】核心指标：表外负债表内化（隐性债务显性化）
    # 包含长期和一年内到期两部分。
    "lease_liabilities_total": {
        "new": ["租赁负债", "一年内到期的非流动负债"],
        "old": ["长期应付款", "一年内到期的非流动负债"],
    },

    # -------------------------------------------------------------------------
    # 3. 资产质量与风险 (Asset Quality & Risk)
    # -------------------------------------------------------------------------

    # 【广义应收票据】核心指标：企业的"准现金"或"可贴现资产"
    # 新准则下，用于背书/贴现的票据计入"应收款项融资"，极易被遗漏。
    "notes_receivable_broad": {
        "new": ["应收票据", "应收款项融资"],
        "old": ["应收票据"],
    },

    # 【减值损失总额】核心指标：利润表的"大洗澡"高发区，吞噬利润的黑洞
    # 新准则引入"预期信用损失"法，拆分为"信用减值"(金融)和"资产减值"(非金融)。
    "impairment_losses": {
        "new": ["信用减值损失", "资产减值损失"],
        "old": ["资产减值损失"],
    },

    # -------------------------------------------------------------------------
    # 4. 成本与费用 (Costs & Expenses)
    # -------------------------------------------------------------------------

    # 【研发投入】核心指标：衡量科技属性
    # 策略：旧准则通常计入管理费用不单列。此处留空，上层逻辑需处理为"N/A"或提示用户查看附注。
    "rd_expenses": {
        "new": ["研发费用"],
        "old": [],
    },

    # 【税费支出】趋势分析指标
    # 2016年营改增后名称变更，统计口径略有扩大（纳入房产税等）。
    "taxes_and_surcharges": {
        "new": ["税金及附加"],
        "old": ["营业税金及附加"],
    },
}

# =============================================================================
# 第二层：扩展金融与投资指标 (Extended Financial & Investment Metrics)
# 适用于金融分析深水区，处理复杂的金融工具分类变化 (CAS 22)
# =============================================================================

EXTENDED_MAPPINGS = {
    # -------------------------------------------------------------------------
    # 资金池与流动性 (Liquidity)
    # -------------------------------------------------------------------------

    # 【广义货币资金】核心指标：还原真实的资金池规模
    # 场景：拥有财务公司的集团，资金拆借给同业赚利息，需加回"拆出资金"。
    "monetary_funds_broad": {
        "new": ["货币资金", "拆出资金"],
        "old": ["货币资金"],
    },

    # -------------------------------------------------------------------------
    # 投资资产 (Investments)
    # -------------------------------------------------------------------------

    # 【权益类金融投资】股票、基金等理财性质资产（偏高风险）
    # 新准则：FVTPL(交易性) + FVOCI(其他权益)
    "financial_investments_equity": {
        "new": ["其他权益工具投资", "交易性金融资产", "其他非流动金融资产"],
        "old": ["可供出售金融资产", "交易性金融资产"],
    },

    # 【债权类金融投资】债券、固收理财（偏稳健/收息）
    # 新准则：以摊余成本计量(债权投资) + FVOCI(其他债权) + FVTPL(交易性)
    "financial_investments_debt": {
        "new": ["债权投资", "其他债权投资", "交易性金融资产"],
        "old": ["持有至到期投资", "可供出售金融资产", "交易性金融资产"],
    },

    # 【全口径金融投资】用于计算"投资总敞口"，避免上述拆分带来的重叠计算问题
    "financial_investments_total": {
        "new": ["债权投资", "其他债权投资", "其他权益工具投资", "交易性金融资产", "其他非流动金融资产"],
        "old": ["持有至到期投资", "可供出售金融资产", "交易性金融资产", "短期投资"],
    },
}

# 合并导出，供 MetricsAccessor 使用
STANDARD_SUBJECT_MAPPING = {**CORE_MAPPINGS, **EXTENDED_MAPPINGS}
